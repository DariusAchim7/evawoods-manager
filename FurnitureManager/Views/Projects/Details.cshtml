@model FurnitureManager.ViewModels.Projects.ProjectDetailsVm

@{
    ViewData["Title"] = $"Proiect: {Model.Project?.Name ?? "Proiect"}";
}

<p>
    <a asp-controller="Clients" asp-action="Details" asp-route-id="@Model.Client.Id">Inapoi la client</a>
</p>

<h1>@Model.Project.Name</h1>
<p style="opacity: 0.8;">Client: @Model.Client.Name</p>

<hr />

<h2>Sumar</h2>
<ul>
    <li>Incasat: @Model.Project.Revenue</li>
    <li>Cheltuieli totale: @Model.TotalExpenses</li>
    <li>Profit: @Model.Profit</li>
</ul>

<hr />

<h2>Adauga cheltuiala</h2>

<form method="post"
      asp-controller="Projects"
      asp-action="AddExpense"
      asp-route-clientId="@Model.Client.Id"
      asp-route-projectId="@Model.Project.Id">
    @Html.AntiForgeryToken()

    <div style="margin-bottom: 8px;">
        <label>Categorie</label><br />
        <select id="categorySelect" name="NewExpenseCategoryId" style="width: 320px;">
            @foreach (var c in Model.Categories)
            {
                <option value="@c.Id" selected="@(c.Id == Model.NewExpenseCategoryId)">
                    @c.Name
                </option>
            }
        </select>
    </div>

    <div style="margin-bottom: 8px;">
        <label>Produs</label><br />
        <select id="productSelect" name="NewProductId" style="width: 320px;">
            @foreach (var p in Model.Products)
            {
                <option value="@p.Id"
                        data-category-id="@p.ExpenseCategoryId"
                        selected="@(p.Id == Model.NewProductId)">
                    @p.Name
                </option>
            }
        </select>
        <div id="noProductsMsg" style="display:none; opacity:0.7; font-size:12px; margin-top:4px;">
            Nu exista produse pentru categoria selectata.
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <label>Cantitate</label><br />
        <input name="NewQty" type="number" step="0.0001" value="@(Model.NewQty == 0 ? 1 : Model.NewQty)" />
    </div>

    <div style="margin-bottom: 8px;">
        <label>Pret unitar</label><br />
        <input name="NewUnitPrice" type="number" step="0.0001" value="@(Model.NewUnitPrice == 0 ? 1 : Model.NewUnitPrice)" />
    </div>

    <div style="margin-bottom: 8px;">
        <label>Nota (optional)</label><br />
        <input name="NewNote" style="width: 520px;" value="@Model.NewNote" />
    </div>

    <button id="submitExpenseBtn" type="submit">Adauga</button>
</form>

<script>
(function () {
    const categorySelect = document.getElementById("categorySelect");
    const productSelect = document.getElementById("productSelect");
    const noProductsMsg = document.getElementById("noProductsMsg");
    const submitBtn = document.getElementById("submitExpenseBtn");

    function filterProducts() {
        const catId = categorySelect.value;
        const options = Array.from(productSelect.options);

        let firstVisibleValue = null;
        let visibleCount = 0;

        options.forEach(opt => {
            const optCatId = opt.getAttribute("data-category-id");
            const isVisible = (optCatId === catId);

            opt.hidden = !isVisible;

            if (isVisible) {
                visibleCount++;
                if (firstVisibleValue === null) firstVisibleValue = opt.value;
            }
        });

        if (visibleCount === 0) {
            productSelect.value = "";
            productSelect.disabled = true;
            noProductsMsg.style.display = "block";
            submitBtn.disabled = true;
            return;
        }

        productSelect.disabled = false;
        noProductsMsg.style.display = "none";
        submitBtn.disabled = false;

        // Daca produsul selectat nu mai e valid, alegem primul produs disponibil din categoria selectata
        const selectedOption = productSelect.selectedOptions[0];
        if (!selectedOption || selectedOption.hidden) {
            productSelect.value = firstVisibleValue;
        }
    }

    categorySelect.addEventListener("change", filterProducts);

    // Aplicam filtrul la incarcare, ca sa fie consistent cu valorile initiale
    filterProducts();
})();
</script>

<hr />

<h2>Cheltuieli</h2>

@if (Model.Expenses.Count == 0)
{
    <p>Nu exista cheltuieli inca.</p>
}
else
{
    <table style="border-collapse: collapse; width: 100%;">
        <thead>
            <tr>
                <th style="text-align:left; border-bottom: 1px solid #ddd; padding: 6px;">Data</th>
                <th style="text-align:left; border-bottom: 1px solid #ddd; padding: 6px;">Categorie</th>
                <th style="text-align:left; border-bottom: 1px solid #ddd; padding: 6px;">Produs</th>
                <th style="text-align:right; border-bottom: 1px solid #ddd; padding: 6px;">Cantitate</th>
                <th style="text-align:right; border-bottom: 1px solid #ddd; padding: 6px;">Pret unitar</th>
                <th style="text-align:right; border-bottom: 1px solid #ddd; padding: 6px;">Total</th>
                <th style="text-align:left; border-bottom: 1px solid #ddd; padding: 6px;">Nota</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in Model.Expenses)
            {
                <tr>
                    <td style="padding: 6px;">@e.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                    <td style="padding: 6px;">@(e.ExpenseCategory?.Name ?? "-")</td>
                    <td style="padding: 6px;">@(e.Product?.Name ?? "-")</td>
                    <td style="padding: 6px; text-align:right;">@e.Qty</td>
                    <td style="padding: 6px; text-align:right;">@e.UnitPrice</td>
                    <td style="padding: 6px; text-align:right;">@(e.Qty * e.UnitPrice)</td>
                    <td style="padding: 6px;">@e.Note</td>
                </tr>
            }
        </tbody>
    </table>
}
